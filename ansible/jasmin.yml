---
# This playbook uses the Ansible OpenStack modules to create a cluster
# using a number of baremetal compute node instances, and configure it
# for a SLURM partition
- hosts: openstack
  roles:
    - role: jasmin.cluster-infra
      cluster_network: "caastest-U-internal"

- hosts: cluster
  tasks:
    - import_tasks: cluster-hosts.yml 

- hosts:
    - nfs
    - compute
    - login
  become: true
  tasks:
    - name: expose NFS services in firewall
      firewalld:
        service: nfs
        state: enabled
        immediate: yes
        permanent: yes

- hosts:
    - cluster
  become: true
  roles:
    - role: resmo.ntp

    - role: stackhpc.cluster-nfs
      nfs_enable:
        server: "{{ inventory_hostname in groups['nfs'] }}"
        clients: "{{ inventory_hostname in groups['compute'] or inventory_hostname in groups['login'] }}"
      nfs_server: "{{ groups['nfs'] | first }}"


- hosts:
    - login
    - compute
  become: yes
  pre_tasks:

    - name: Ensure user home dir root exists
      file:
        path: "{{ jasmin_homedir }}"
        state: directory

  roles:
    - role: singleplatform-eng.users
      users: "{{ jasmin_users }}"
      groups_to_create: "{{ jasmin_groups }}"

- hosts:
    - login
  become: yes
  tasks:

    - name: Ensure the ports for slurmctld are open in firewalld
      firewalld:
        port: "{{item}}"
        state: enabled
        immediate: yes
        permanent: yes
      with_items:
        - "6817/tcp"
        - "62000-63999/tcp"

- hosts:
    - compute
  become: yes
  tasks:

    - name: Ensure the ports for slurmd are open in firewalld
      firewalld:
        port: "6818/tcp"
        state: enabled
        immediate: yes
        permanent: yes

        
- hosts:
    - login
    - compute
  become: yes
  pre_tasks:

    - name: Ensure the OpenHPC package repo rpm is present
      yum:
        name: "https://github.com/openhpc/ohpc/releases/download/v1.3.GA/ohpc-release-1.3-1.el7.x86_64.rpm"
        state: present

    - name: Ensure latest python is present
      yum:
        name: python
        state: latest

  roles:
    - role: stackhpc.openhpc
      openhpc_enable:
        control: "{{ inventory_hostname in groups['login'] }}"
        batch: "{{ inventory_hostname in groups['compute'] }}"
        runtime: true
      slurm_cluster_name: "{{ cluster_name }}"
      slurm_partitions: "{{ openhpc_slurm_partitions }}"
      slurm_control_host: "{{ groups['login'] | first }}"
      slurm_srun_port_range:
        lower: 62000
        upper: 63999

