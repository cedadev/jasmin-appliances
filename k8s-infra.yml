---
#####
## Playbook that provisions and then configures a Kubernetes
## cluster on OpenStack
#####

# Provision the cluster infrastructure
- hosts: openstack
  tasks:
    - import_tasks: tasks/install-dependencies.yml
    - import_tasks: tasks/infra/provision.yml
      vars:
        # These are the groups to use when no fixed IP is given
        cluster_groups: "{{ k8s_groups_no_ip }}"
        # This is the gateway group to use when a fixed IP is given
        cluster_gw_group_fixed_ip: "{{ k8s_gw_group_name }}"
        # These are the groups to use when a fixed IP is given
        cluster_groups_fixed_ip: "{{ k8s_groups_fixed_ip }}"
        # Tag to assign to the cluster
        cluster_tag: "{{ cluster_type.kubernetes }}"
    # Generate keystone trust token
    - import_tasks: tasks/os-keystone-trust.yml
      when: cluster_state | default('present') | lower == 'present'

# Do cluster setup for all hosts
#   If cluster_state=absent, this play will be skipped as the inventory will be empty
- hosts: kube-masters,kube-workers
  roles:
    - role: jasmin.k8s/kubeadm
      kube_role: "{{ 'master' if inventory_hostname in groups['kube-masters'] else 'worker' }}"
      openstack_trust_id: "{{ hostvars[groups['openstack'] | first]['openstack_trust_id'] }}"
      openstack_project_id: "{{ hostvars[groups['openstack'] | first]['openstack_project_id'] }}"
      kubernetes_version: "{{ cluster_version }}"
      upgrade_system_packages: "{{ cluster_upgrade_system_packages | default(false) }}"
  become: yes

# Install addons via the master
#   If cluster_state=absent, this play will be skipped as the inventory will be empty
- hosts: kube-masters
  roles:
    - jasmin.k8s/helm
    - jasmin.k8s/ingress_nginx
    - jasmin.k8s/kubernetes_dashboard
  become: yes

- import_playbook: validate-kubernetes.yml

# Delete the gateway if required
- hosts: openstack
  tasks:
    - import_tasks: tasks/infra/cleanup-gateway.yml
      vars:
        cluster_groups: "{{ k8s_groups_no_ip }}"
        cluster_tag: "{{ cluster_type.kubernetes }}"
